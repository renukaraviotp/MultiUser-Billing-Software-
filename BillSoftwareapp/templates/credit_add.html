{% extends 'base.html' %}
{% block content %}
{% load static %}
<head>
    <script src="https://kit.fontawesome.com/fbe819dd43.js" crossorigin="anonymous"></script>
    <!-- Add these in the head section of your HTML -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  

</head>
<style>
    #input,select,textarea{
        box-shadow: 2px 2px 2px gray;
    }
    #input:hover{
        box-shadow: none;
    }
    label{
        color: black;
    }
    body{
        background-color: rgb(130, 144, 199);
        
    }
    .party {
        margin: 20px;
      }
  
      .toggle-control {
        display: inline-block;
        position: relative;
        width: 60px;
        height: 34px;
      }
  
      .abc {
        opacity: 0;
        width: 0;
        height: 0;
      }
  
      .control {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        border-radius: 17px; /* Half of the height for rounded appearance */
        -webkit-transition: .4s;
        transition: .4s;
      }
  
      .control:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        border-radius: 50%; /* Rounded for the checkbox */
        -webkit-transition: .4s;
        transition: .4s;
      }
  
      .abc:checked + .control {
        background-color: #2196F3;
      }
  
      .abc:focus + .control {
        box-shadow: 0 0 1px #2196F3;
      }
  
      .abc:checked + .control:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
      }
      .search-box{
        width:100px;
        background:#fff;
        margin:200px auto 0;
        border-radius:5px;
      }
      th{
        color:black;
        font-weight:bold;
      }
        
      
      

</style>
<!-- Add this in the head section of your HTML -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


<div class="container col-md-10 mr-1" style="background-color: rgb(130, 144, 199);min-height: 100vh;" >
    <br><br><br><br><br>    
    <form action="{% url "credit_save" %}" class="col-10 container" method="get" enctype="multipart/form-data" style="background-color: white; padding: 30px; border-radius: 15px;box-shadow: 4px 3px 4px gray;">
        {% comment %} {% csrf_token %} {% endcomment %}
        <div class="container col-md-10">
            <h2>Add Credit Note</h2><br>
            {% for m in messages %}
            <h5 style="background-color: rgba(255, 0, 0, 0.4);color: red;font-size: larger;padding: 10px;border-radius: 10px;text-align: center;">{{m}}</h5>
            {% endfor %}

            <div class='party'>
                <h3>Party</h3>
                <label class="toggle-control">
                    <input class='abc' type="checkbox" name="abc" id="partyCheckbox" checked>
                    <span class="control"></span>
                </label>
            </div>
            <div id="partyForm" class="form-group row">
                    <div class="col-md-3 custom-dropdown">
                        <label for=""> Party Name:</label>
                            
                                <input type="text" class="dropdown-input form-control" id="ip" placeholder='Search Party' onchange="fillEmployeeDetails(this.value)">

                                <ul id="employee" class="dropdown-list">
                                    {% for p in party %}
                                        <li class="dropdown-item"
                                            data-value="{{ p.party_name }}"
                                            data-party-id="{{ p.id }}" data-phone="{{ p.phone_number}}" data-address="{{ p.billing_address }}" data-balance="{{p.opening_balance}}"
                                            onclick="fillEmployeeDetails('{{ p.party_name }}')">
                                            {{ p.party_name }}
                                        </li>
                                    {% endfor %} 
                                </ul>    
                                <a href="{% url 'parties_add_page' %}" id="input" style="background-color: #3d4465;color: white; font-size: 14px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='#480ceb'" onmouseout="this.style.backgroundColor='#3d4465'" class="btn col-md-1" ><i class="fa-solid fa-plus"></i></a>

                            
                            <small>Available Balance</small>
                    </div>
                    
                    <div class="col-md-4"><label for=""> Phone Number:</label><input id="ph" type="text" name="number" class="form-control" pattern="[0-9]{10}" placeholder="Phone Number" readonly></div>
                    <div class="col-md-4"><label for="">Billing Address</label>
                        <textarea name="address" id="ad" cols="10" rows="4" class="form-control" placeholder="Billing Address..." readonly></textarea></div>
                
                </div>
            

            <div class="form-group row">
                <div class="col"><label for=""> Return No.</label><input id="input" type="number" value="{{i.id}}" name="returnno" class="form-control" placeholder="Return Number" ></div>
                <div class="col"><label for=""> Bill No.</label><input id="input" type="text" name="billno" class="form-control" placeholder="Bill Number" ></div>
                <div class="col"><label for=""> Bill Date</label><input id="input" type="text" name="billdate" class="form-control" placeholder="Bill Date"> </div>
                
            </div>
        

            

            <div class="row form-group">
                <div class="col"><label for="">Date</label><input type="date" name="date" value="{{todaydate}}" class="form-control"></div>

                <div class="col-md">
                    <label for="">State of Supply:</label>
                        <select name="gsttype" class="form-control">
                            <option value="">--Select--</option>
                            <option value="state">State(GST)</option>
                            <option value="others">Others(IGST)</option>
                        </select>
                </div>
    
            </div>
        </div>

        <script>
            document.getElementById('partyCheckbox').addEventListener('change', function() {
                var partyForm = document.getElementById('partyForm');
                partyForm.style.display = this.checked ? 'flex' : 'none';
            });
            document.addEventListener('DOMContentLoaded', function() {
            var dateInput = document.getElementsByName('date')[0];
            dateInput.value = ''; // Set the default value to an empty string
        });

        document.addEventListener('DOMContentLoaded', function () {
            var input = document.querySelector('.dropdown-input');
            var dropdownList = document.querySelector('#employee');
    
            input.addEventListener('focus', function () {
                dropdownList.style.display = 'block';
            });
    
            document.addEventListener('mousedown', function (event) {
                if (!event.target.closest('.custom-dropdown')) {
                    dropdownList.style.display = 'none';
                }
            });
    
            dropdownList.addEventListener('click', function (event) {
                if (event.target.classList.contains('dropdown-item')) {
                    input.value = event.target.textContent;
                    dropdownList.style.display = 'none';
                    fillEmployeeDetails();
                    clearErrorMessage();
                }
            });
    
            input.addEventListener('input', function () {
                var filterValue = input.value.toLowerCase();
                var items = dropdownList.querySelectorAll('.dropdown-item');
    
                items.forEach(function (item) {
                    var itemText = item.textContent.toLowerCase();
                    if (itemText.includes(filterValue)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });

        // Function to fetch phone number and address based on selected party name
        function fillEmployeeDetails(selectedParty) {
            $.ajax({
                url: "{% url "credit_add" %}",
                data: { party_name: selectedParty },
                type: 'GET',
                success: function (data) {
                    // Update the phone number and address fields
                    document.getElementById('ph').value = data.phone_number;
                    document.getElementById('ad').value = data.billing_address;
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        }
        

            {% comment %} function getEmail(){
                // Get the <select> element
                var selectElement = document.getElementById("ip");
            
                // Get the selected option
                var selectedOption = selectElement.options[selectElement.selectedIndex];
            
                // Get the data-email attribute value
                var phone = selectedOption.getAttribute("data-phone");
                console.log(phone)
                document.getElementById("ph").value = phone;
            } {% endcomment %}


            
        </script>
</form>
</div>
</div>
<div class="container col-md-10 mr-1" style="background-color: rgb(130, 144, 199);min-height: 100vh;">
    <br><br><br><br><br><br>
    <div class="col-11 container mr-1">
        <div class="row">
            <!-- party table -->
            <div class="col-11 table-responsive" style="background-color: white;padding: 30px;border-radius: 15px;box-shadow: 3px 3px 3px gray;">
                <div class="row">
                    <h3>Item </h3>
                    <div class="dropdown ml-2"></div>
                </div>
                <br>
                <div class="row">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th class="">SL.No</th>
                                <th class="">PRODUCT </th>
                                <th class="">HSN</th>
                                <th class="">QTY</th>
                                <th class="">PRICE </th>
                                <th class="">TAX(%)</th>
                                <th class="">DISCOUNT</th>
                                <th class="">TOTAL </th>
                                <th class="">FIELD</th>
                            </tr>
                        </thead>
                        <tbody id='dynamicadd'>
                            <tr>
                                {% comment %} <td></td>
                                <td>
                                    <div class="input-group">
                                        <input type="text" name="product[]" id="product" class="form-control" placeholder="Product">
                                        <a href="" id="input" style="background-color: #3d4465;color: white; font-size: 14px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='#480ceb'" onmouseout="this.style.backgroundColor='#3d4465'" class="btn col-md-1"><i class="fa-solid fa-plus"></i></a>
                                    </div>
                                </td>
                                <td><input type="text" name="hsn[]" id="hsn" class='form-control' style="width:90px;"></td>
                                <td><input type="number" name="qty[]" id="qty" class='form-control' style="width:40px;"></td>
                                <td><input type="text" name="price[]" id="price" class='form-control' style="width:50px;"></td>
                                <td><input type="text" name="tax[]" id="tax" class='form-control' style="width:80px;"></td>
                                <td><input type="number" name="discount[]" id="discount" class='form-control' style="width:70px;"></td>
                                <td><input type="number" name="total[]" id="total" class='form-control' style="width:60px;"></td>
                                <td>
                                    <button type='button' class='btn btn-danger'><i class="fa-solid fa-square-minus"></i></button>
                                </td> {% endcomment %}
                            </tr>
                        </tbody>
                    </table>
                    <button type='button' id='add' class='btn btn-success'>+</button>
                </div>
            </div>
        </div>
    </div><br>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type='text/javascript'>
        $(document).ready(function () {
            var i = 1;
    
            // Initial SL.No
            updateSerialNumbers();
    
            $('#add').click(function () {
                i++;
                $('#dynamicadd').append('<tr id="row' + i + '"><td class="serial-no"></td><td><div class="input-group"><input type="text" name="product[]" id="product" class="form-control"><a href="" id="input" style="background-color: #3d4465;color: white; font-size: 14px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor=\'#480ceb\'" onmouseout="this.style.backgroundColor=\'#3d4465\'" class="btn col-md-1"><i class="fa-solid fa-plus"></i></a></div></td><td><input type="text" name="hsn[]" id="hsn" class="form-control" style="width:90px;"></td><td><input type="number" name="qty[]" id="qty" class="form-control" style="width:40px;"></td><td><input type="text" name="price[]" id="price" class="form-control" style="width:50px;"></td><td><input type="text" name="tax[]" id="tax" class="form-control" style="width:80px;"></td><td><input type="number" name="discount[]" id="discount" class="form-control" style="width:70px;"></td><td><input type="number" name="total[]" id="total" class="form-control" style="width:60px;"></td><td><button type="button" id="' + i + '" class="btn btn-danger remove_row"><i class="fa-solid fa-square-minus"></i></button></td></tr>');
    
                // Update SL.No after adding a new row
                updateSerialNumbers();
            });
    
            $(document).on('click', '.remove_row', function () {
                var row_id = $(this).attr("id");
                $('#row' + row_id + '').remove();
    
                // Update SL.No after removing a row
                updateSerialNumbers();
            });
    
            function updateSerialNumbers() {
                $('.serial-no').each(function (index) {
                    $(this).text(index + 1);
                });
            }
        });
    </script>
    
</div>
  <br>
    <div class="container col-md-6 mr-5" style="background-color: rgb(130, 144, 199);min-height: 100vh;">
        <form action="" class="col-10 container" method="post" enctype="multipart/form-data" style="background-color: #869deb; padding: 30px; border-radius: 15px;box-shadow: 4px 3px 4px gray; display: flex; flex-direction: column;">
    {% csrf_token %}
    <div class="form-group" style="display: flex; flex-direction: column; gap: 15px;">
        <div style="display: flex; flex-direction: row; align-items: center;"><label for="subtotal" >Sub Total</label><input id="subtotal" type="number" name="subtotal" class="form-control ml-auto" placeholder="" style="width:200px;"></div>
        <div style="display: flex; flex-direction: row; align-items: center;"><label for="gst">GST</label><input id="gst" type="text" name="gst" class="form-control ml-auto" placeholder="" style="width:200px;"></div>
        <div style="display: flex; flex-direction: row; align-items: center;"><label for="adjustment">Tax Amount</label><input id="adjustment" type="text" name="adjustment" class="form-control ml-auto" placeholder="" style="width:200px;"></div>
        <div style="display: flex; flex-direction: row; align-items: center;"><label for="grandtotal">Round Off</label><input id="roundoff" type="text" name="roundoff" class="form-control ml-auto" placeholder="" style="width:200px;"></div>
        <div style="display: flex; flex-direction: row; align-items: center;"><label for="paidoff">Grand Total</label><input id="grandtotal" type="text" name="grandtotal" class="form-control ml-auto" placeholder="" style="width:200px;"></div>
        <div style="display: flex; flex-direction: row; align-items: center;"><label for="balance">Description</label><input id="des" type="text" name="des" class="form-control ml-auto" placeholder="" style="width:200px;"></div>
    </div>
</form>
<br><br>
<div class="ml-auto">
    <center>
        <button style="background-color: #3d4465;color: white;" onmouseover="this.style.backgroundColor='#480ceb'" onmouseout="this.style.backgroundColor='#3d4465'" class="btn  " value="new" name="buttonn">Save & New</button> 
        <button style="background-color: #3d4465;color: white;" onmouseover="this.style.backgroundColor='#480ceb'" onmouseout="this.style.backgroundColor='#3d4465'" class="btn " value="old" name="buttonn"><a href="{% url "transactiontable" %}">Save</a> </button> 
    </center><br><br>
    </div>
    </div> 
    
</div>
<script>    
// ------------------------------------------------------------------------------------------------------------


        function validateGSTIN() {
            // Get the input value
            var gstinInput = document.getElementById('gstinInput').value.trim();

            // Define the GSTIN pattern
            var gstinPattern = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[0-9]{1}Z[0-9]{1}$/;

            // Check if the input matches the pattern
            if (!gstinPattern.test(gstinInput)) {
                // Set a custom validation message
                document.getElementById('gstinInput').setCustomValidity('Please enter a valid GSTIN number.');
            } else {
                // Clear the custom validation message
                document.getElementById('gstinInput').setCustomValidity('');
            }
        }

        
    
// ------------------------------------------------------------------------------------------------------------
$(function() {
    $(".party-autocomplete").autocomplete({
        source: "/autocomplete/",  // Replace with your actual autocomplete endpoint
        minLength: 2,
        select: function(event, ui) {
            var selectedParty = ui.item.value;
            fetchAvailableBalance(selectedParty);
        }
    });

    function fetchAvailableBalance(selectedParty) {
        $.ajax({
            url: "/get_available_balance/",  //  endpoint
            data: { party: selectedParty },
            success: function(data) {
                // Update the available balance text
                $("#availableBalanceValue").text(data.available_balance || 'N/A');
            }
        });
    }
});


{% comment %} //---------------------------searchdropdown------------------------------ {% endcomment %}

{% comment %} $(document).ready(function() {
    // Initialize Select2 for the hidden select element
    $('#selectedParty').select2();

    // Handle autocomplete for the input field
    $('#searchInput').on('input', function() {
        var searchTerm = $(this).val().toLowerCase();

        // Filter options based on the entered value
        var filteredOptions = $('#selectedParty option').filter(function() {
            return $(this).text().toLowerCase().includes(searchTerm);
        });

        // Update the Select2 dropdown with filtered options
        $('#selectedParty').empty().append(filteredOptions).trigger('change');
    });
}); {% endcomment %}

$(document).ready(function () {
    $('#partySelect').select2({
        placeholder: 'Search for a party',
        minimumInputLength: 1, // Minimum characters before triggering a search
        ajax: {
            url: '/autocomplete-parties/', // Replace with your actual autocomplete endpoint
            dataType: 'json',
            delay: 250,
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        }
    });
});

// ----------------------------------------------------------------------------------------------------

function addRow() {
    var table = document.getElementById("itemTable").getElementsByTagName('tbody')[0];
    var newRow = table.insertRow(table.rows.length);
    var cells = [];

    for (var i = 0; i < 9; i++) {
        cells[i] = newRow.insertCell(i);
    }

    cells[1].innerHTML = '<div class="input-group">' +
                            '<input type="text" name="product" class="form-control party-autocomplete" placeholder="Product" required>' +
                            '<a href="#" class="btn col-md-1"><i class="fa-solid fa-plus"></i></a>' +
                         '</div>';
    cells[2].innerHTML = '<input type="text" name="" style="width:90px;">';
    cells[3].innerHTML = '<input type="number" name="" style="width:40px;">';
    cells[4].innerHTML = '<input type="text" name="" style="width:50px;">';
    cells[5].innerHTML = '<input type="text" name="" style="width:80px;">';
    cells[6].innerHTML = '<input type="number" name="" style="width:70px;">';
    cells[7].innerHTML = '<input type="number" name="" style="width:60px;">';
    cells[8].innerHTML = '<a href=""><i class="fa-solid fa-clone"></i></a><br>' +
                         '<a href=""><i class="fa-solid fa-square-minus"></i></a>';
}

</script>


{% endblock %}